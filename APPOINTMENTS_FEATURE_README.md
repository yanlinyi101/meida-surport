# 预约功能使用说明

## 功能概述

本系统新增了完整的预约管理功能，包括：

- ✅ **用户端预约提交** - 用户可通过表单提交服务预约
- ✅ **CSV本地落盘** - 预约数据自动保存到本地CSV文件
- ✅ **并发安全** - 使用文件锁确保多用户同时提交的安全性
- ✅ **CSV注入防护** - 自动转义危险字符防止CSV注入攻击
- ✅ **管理端统计** - 管理员可查看统计信息和下载数据
- ✅ **数据验证** - 完整的前后端数据验证

## 文件结构

```
backend/app/
├── api/appointments.py          # 预约API路由
├── core/config.py              # 配置文件（新增CSV配置）
└── main.py                     # 主应用（新增路由）

templates/
├── booking.html                # 用户端预约表单页面
└── admin_appointments.html     # 管理端预约管理页面

data/exports/
└── appointments.csv            # 预约数据CSV文件（自动创建）
```

## 环境变量配置

可通过 `.env` 文件配置以下参数：

```env
# CSV导出配置
EXPORTS_DIR=./data/exports
APPOINTMENTS_CSV=./data/exports/appointments.csv
```

## API 接口文档

### 1. 用户端预约提交

**接口地址：** `POST /api/public/booking`

**请求参数：**
```json
{
  "name": "张三",                    // 姓名 (必填，1-50字符)
  "phone": "13912345678",           // 联系电话 (必填，5-30字符)
  "address": "上海市浦东新区...",     // 服务地址 (必填，1-200字符)
  "date": "2025-09-21",            // 预约日期 (必填，YYYY-MM-DD格式)
  "time": "09:30",                 // 预约时间 (必填，HH:MM格式)
  "issue": "集成灶E1故障..."        // 问题描述 (必填，1-500字符)
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "预约提交成功！我们会尽快联系您。",
  "booking_id": "BK20250920140220"
}
```

### 2. 管理端统计查询

**接口地址：** `GET /api/admin/appointments/stats`

**权限要求：** 需要管理员登录

**响应示例：**
```json
{
  "total_appointments": 5,
  "appointments_by_date": {
    "2025-09-21": 3,
    "2025-09-22": 2
  },
  "recent_appointments": [
    {
      "booking_id": "BK20250920140220",
      "name": "张三",
      "phone": "13912345678",
      "date": "2025-09-21",
      "time": "09:30",
      "submit_time": "2025-09-20 14:02:20"
    }
  ]
}
```

### 3. 管理端CSV下载

**接口地址：** `GET /api/admin/appointments/download`

**权限要求：** 需要管理员登录

**响应：** 返回CSV文件下载

## 页面访问

### 用户端页面

- **预约表单页面：** `http://localhost:8000/booking`
  - 包含完整的预约表单
  - 前端验证和用户体验优化
  - 实时提交状态反馈

### 管理端页面

- **管理后台主页：** `http://localhost:8000/admin/dashboard`
  - 需要管理员登录
  - 点击"数据统计"卡片中的"预约统计"按钮
  - 弹窗显示预约统计信息
  - 支持CSV数据下载
  - 显示最近预约记录

## CSV 文件格式

CSV文件包含以下字段：

| 字段名 | 说明 | 示例 |
|--------|------|------|
| 预约编号 | 自动生成的唯一编号 | BK20250920140220 |
| 姓名 | 用户姓名 | 张三 |
| 联系电话 | 用户电话 | 13912345678 |
| 地址 | 服务地址 | 上海市浦东新区... |
| 预约日期 | 预约服务日期 | 2025-09-21 |
| 预约时间 | 预约服务时间 | 09:30 |
| 问题描述 | 故障描述 | 集成灶E1故障... |
| 提交时间 | 预约提交时间戳 | 2025-09-20 14:02:20 |

**特性：**
- UTF-8 BOM 编码（Excel友好）
- 自动转义危险字符防止CSV注入
- 文件锁保证并发安全

## 安全特性

### 1. CSV注入防护

系统自动检测并转义以下危险字符开头的内容：
- `=` (公式)
- `+` (公式)  
- `-` (公式)
- `@` (公式)
- `\t` (制表符)

**示例：**
```
输入: =cmd|'/c calc'!A0
输出: '=cmd|'/c calc'!A0
```

### 2. 数据验证

- **前端验证：** JavaScript实时验证
- **后端验证：** Pydantic模型验证
- **字段限制：** 长度、格式、必填项检查

### 3. 并发安全

使用 `filelock` 库确保多用户同时提交时的文件写入安全。

## 启动和测试

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 启动服务

```bash
python -m backend.app.main
```

或使用uvicorn：
```bash
uvicorn backend.app.main:app --host 127.0.0.1 --port 8000 --reload
```

### 3. 运行测试

```bash
python test_appointments.py
```

测试脚本会验证：
- 健康检查
- 预约提交功能
- CSV注入防护
- 数据验证
- 并发安全
- CSV文件生成

## 常见问题

### Q1: CSV文件在哪里？
A: 默认位置是 `./data/exports/appointments.csv`，可通过环境变量 `APPOINTMENTS_CSV` 配置。

### Q2: 如何修改CSV文件位置？
A: 在 `.env` 文件中设置：
```env
APPOINTMENTS_CSV=/path/to/your/appointments.csv
```

### Q3: 管理端页面需要登录吗？
A: 是的，管理端的统计和下载功能需要管理员权限。

### Q4: 支持并发提交吗？
A: 是的，使用文件锁机制确保多用户同时提交的安全性。

### Q5: 如何防止CSV注入攻击？
A: 系统自动检测并转义危险字符，无需手动处理。

## 技术实现细节

### 依赖包
- `fastapi` - Web框架
- `pydantic` - 数据验证
- `filelock` - 文件锁
- `email-validator` - 邮箱验证

### 关键技术点
1. **文件锁机制**：使用 `FileLock` 确保CSV写入的原子性
2. **UTF-8 BOM编码**：确保Excel正确显示中文
3. **CSV注入防护**：自动转义危险字符
4. **响应式设计**：前端页面适配移动端
5. **错误处理**：完整的异常处理和用户友好的错误提示

## 功能使用方法

### 管理员使用步骤

1. **登录管理后台**
   - 访问 `http://localhost:8000/admin`
   - 使用管理员账号登录

2. **查看预约统计**
   - 登录后进入管理后台主页 `http://localhost:8000/admin/dashboard`
   - 找到"数据统计"卡片
   - 点击"预约统计"按钮

3. **使用统计功能**
   - 查看总预约数、今日预约、本周预约
   - 查看按日期统计的预约分布
   - 查看最近预约记录详情
   - 点击"下载CSV数据"按钮导出完整数据
   - 点击"刷新数据"按钮更新统计信息

### 用户使用步骤

1. **提交预约**
   - 访问 `http://localhost:8000/booking`
   - 填写预约表单（姓名、电话、地址、日期、时间、问题描述）
   - 点击"提交预约"按钮
   - 获得预约编号确认

## 更新日志

### v1.1.0 (2025-09-20)
- ✅ 将预约统计功能集成到管理后台主页
- ✅ 使用弹窗形式展示统计信息
- ✅ 优化用户体验和界面设计
- ✅ 删除独立的预约管理页面
- ✅ 简化管理员操作流程

### v1.0.0 (2025-09-20)
- ✅ 实现用户端预约提交功能
- ✅ 实现CSV本地落盘存储
- ✅ 实现管理端统计和下载功能
- ✅ 实现CSV注入防护
- ✅ 实现并发安全机制
- ✅ 完整的数据验证
- ✅ 响应式用户界面 