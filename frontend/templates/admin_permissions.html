<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒé™ç®¡ç† - ç¾å¤§å®¢æœæ”¯æŒç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
    <style>
        .loading { display: none; }
        .loading.show { display: block; }
        .permission-category {
            @apply border rounded-lg p-4 mb-4 bg-white;
        }
        .permission-item {
            @apply flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0;
        }
        .category-badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/admin" class="text-xl font-bold text-gray-800 flex items-center space-x-2">
                        <span class="text-2xl">ğŸ‘¨â€ğŸ’¼</span>
                        <span>ç®¡ç†åå°</span>
                    </a>
                    <div class="ml-6 flex space-x-4">
                        <a href="/admin" class="text-gray-600 hover:text-gray-900">ä»ªè¡¨æ¿</a>
                        <a href="/admin/roles" class="text-gray-600 hover:text-gray-900">è§’è‰²ç®¡ç†</a>
                        <a href="#" class="text-blue-600 font-medium">æƒé™ç®¡ç†</a>
                        <a href="/admin/users" class="text-gray-600 hover:text-gray-900">ç”¨æˆ·ç®¡ç†</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-gray-900">è¿”å›é¦–é¡µ</a>
                    <button onclick="logout()" class="text-red-600 hover:text-red-900">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">æƒé™ç®¡ç†</h1>
            <p class="text-gray-600">æŸ¥çœ‹ç³»ç»Ÿä¸­æ‰€æœ‰å¯ç”¨çš„æƒé™ï¼Œæƒé™é€šè¿‡è§’è‰²è¿›è¡Œåˆ†é…</p>
        </div>

        <!-- Filters -->
        <div class="mb-6 bg-white rounded-lg shadow p-4">
            <div class="flex space-x-4">
                <div class="flex-1">
                    <select id="categoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">æ‰€æœ‰åˆ†ç±»</option>
                    </select>
                </div>
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="æœç´¢æƒé™ä»£ç æˆ–æè¿°..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="filterPermissions()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    ğŸ” ç­›é€‰
                </button>
                <button onclick="resetFilter()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                    ğŸ”„ é‡ç½®
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loadingSpinner">
            <div class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <!-- Permissions Display -->
        <div id="permissionsContainer" class="hidden">
            <!-- Permission categories will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <div class="mx-auto h-12 w-12 text-gray-400">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                </svg>
            </div>
            <h3 class="mt-2 text-sm font-medium text-gray-900">æ²¡æœ‰æ‰¾åˆ°æƒé™</h3>
            <p class="mt-1 text-sm text-gray-500">å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
        </div>

        <!-- Statistics -->
        <div id="statsContainer" class="mt-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Statistics cards will be inserted here -->
        </div>
    </div>

    <script>
        // Global state
        let allPermissions = [];
        let filteredPermissions = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPermissions();
            
            // Search on enter key
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterPermissions();
                }
            });
        });

        // Load permissions
        async function loadPermissions() {
            try {
                showLoading(true);
                
                const response = await fetch('/api/admin/permissions', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load permissions');
                }
                
                allPermissions = await response.json();
                filteredPermissions = [...allPermissions];
                
                populateCategoryFilter();
                displayPermissions();
                displayStatistics();
                
            } catch (error) {
                console.error('Error loading permissions:', error);
                alert('åŠ è½½æƒé™å¤±è´¥ï¼š' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Populate category filter dropdown
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = [...new Set(allPermissions.map(cat => cat.category))];
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = getCategoryDisplayName(category);
                categoryFilter.appendChild(option);
            });
        }

        // Display permissions by category
        function displayPermissions() {
            const container = document.getElementById('permissionsContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredPermissions.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            container.innerHTML = '';
            
            filteredPermissions.forEach(category => {
                if (category.items.length === 0) return;
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'permission-category';
                
                // Category header
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-4';
                header.innerHTML = `
                    <h3 class="text-lg font-medium text-gray-900">${getCategoryDisplayName(category.category)}</h3>
                    <span class="category-badge bg-blue-100 text-blue-800">${category.items.length} ä¸ªæƒé™</span>
                `;
                categoryDiv.appendChild(header);
                
                // Permission items
                category.items.forEach(permission => {
                    const permissionDiv = document.createElement('div');
                    permissionDiv.className = 'permission-item';
                    
                    permissionDiv.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <code class="px-2 py-1 bg-gray-100 text-gray-800 text-sm rounded font-mono">${permission.code}</code>
                                <span class="text-sm text-gray-900">${permission.description}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500">ID: ${permission.id}</span>
                        </div>
                    `;
                    
                    categoryDiv.appendChild(permissionDiv);
                });
                
                container.appendChild(categoryDiv);
            });
        }

        // Display statistics
        function displayStatistics() {
            const statsContainer = document.getElementById('statsContainer');
            
            // Calculate stats
            const totalPermissions = allPermissions.reduce((sum, cat) => sum + cat.items.length, 0);
            const categoriesCount = allPermissions.length;
            
            // Category with most permissions
            const maxCategory = allPermissions.reduce((max, cat) => 
                cat.items.length > max.items.length ? cat : max, 
                {items: [], category: 'none'}
            );
            
            // Permission codes by prefix
            const prefixes = {};
            allPermissions.forEach(cat => {
                cat.items.forEach(perm => {
                    const prefix = perm.code.split('.')[0];
                    prefixes[prefix] = (prefixes[prefix] || 0) + 1;
                });
            });
            
            const topPrefix = Object.entries(prefixes).reduce((max, [prefix, count]) => 
                count > max.count ? {prefix, count} : max, 
                {prefix: 'none', count: 0}
            );
            
            const stats = [
                {
                    title: 'æ€»æƒé™æ•°',
                    value: totalPermissions,
                    icon: 'ğŸ”',
                    color: 'bg-blue-100 text-blue-800'
                },
                {
                    title: 'æƒé™åˆ†ç±»',
                    value: categoriesCount,
                    icon: 'ğŸ“‚',
                    color: 'bg-green-100 text-green-800'
                },
                {
                    title: 'æœ€å¤§åˆ†ç±»',
                    value: `${getCategoryDisplayName(maxCategory.category)} (${maxCategory.items.length})`,
                    icon: 'ğŸ“Š',
                    color: 'bg-yellow-100 text-yellow-800'
                },
                {
                    title: 'ä¸»è¦å‰ç¼€',
                    value: `${topPrefix.prefix} (${topPrefix.count})`,
                    icon: 'ğŸ·ï¸',
                    color: 'bg-purple-100 text-purple-800'
                }
            ];
            
            statsContainer.innerHTML = '';
            stats.forEach(stat => {
                const statCard = document.createElement('div');
                statCard.className = 'bg-white overflow-hidden shadow rounded-lg';
                statCard.innerHTML = `
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <span class="text-2xl">${stat.icon}</span>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">${stat.title}</dt>
                                    <dd class="text-lg font-medium text-gray-900">${stat.value}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                `;
                statsContainer.appendChild(statCard);
            });
        }

        // Filter permissions
        function filterPermissions() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            filteredPermissions = allPermissions.filter(category => {
                // Filter by category
                if (categoryFilter && category.category !== categoryFilter) {
                    return false;
                }
                
                // Filter items within category
                const filteredItems = category.items.filter(permission => {
                    if (!searchQuery) return true;
                    
                    return permission.code.toLowerCase().includes(searchQuery) ||
                           permission.description.toLowerCase().includes(searchQuery);
                });
                
                return filteredItems.length > 0;
            }).map(category => ({
                ...category,
                items: category.items.filter(permission => {
                    if (!searchQuery) return true;
                    
                    return permission.code.toLowerCase().includes(searchQuery) ||
                           permission.description.toLowerCase().includes(searchQuery);
                })
            }));
            
            displayPermissions();
        }

        // Reset filter
        function resetFilter() {
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchInput').value = '';
            filteredPermissions = [...allPermissions];
            displayPermissions();
        }

        // Get category display name
        function getCategoryDisplayName(category) {
            const names = {
                'users': 'ğŸ‘¥ ç”¨æˆ·ç®¡ç†',
                'roles': 'ğŸ›¡ï¸ è§’è‰²æƒé™',
                'permissions': 'ğŸ” æƒé™ç®¡ç†',
                'audit': 'ğŸ“Š å®¡è®¡æ—¥å¿—',
                'tickets': 'ğŸ« å·¥å•ç®¡ç†',
                'warranty': 'ğŸ› ï¸ ä¿ä¿®ç®¡ç†',
                'centers': 'ğŸ¢ æœåŠ¡ä¸­å¿ƒ',
                'ai': 'ğŸ¤– AIåŠŸèƒ½',
                'geo': 'ğŸŒ åœ°ç†ä½ç½®',
                'system': 'âš™ï¸ ç³»ç»Ÿç®¡ç†'
            };
            return names[category] || category;
        }

        // Show/hide loading
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const container = document.getElementById('permissionsContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (show) {
                spinner.classList.add('show');
                container.classList.add('hidden');
                emptyState.classList.add('hidden');
            } else {
                spinner.classList.remove('show');
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/admin';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
    </script>
</body>
</html> 